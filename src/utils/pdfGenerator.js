import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';

// í™”ë©´ ìº¡ì²˜ í›„ PDF ìƒì„± (í•œê¸€ ì§€ì›)
export async function generatePDF() {
  try {
    // ë¶„ì„ ê²°ê³¼ í™”ë©´ ìš”ì†Œ ì°¾ê¸°
    const element = document.querySelector('.max-w-4xl'); // AnalysisResult ë©”ì¸ ì»¨í…Œì´ë„ˆ
    
    if (!element) {
      throw new Error('PDF ìƒì„±í•  í™”ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // í™”ë©´ì„ ì´ë¯¸ì§€ë¡œ ìº¡ì²˜
    const canvas = await html2canvas(element, {
      scale: 2, // ê³ í•´ìƒë„
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff',
      width: element.scrollWidth,
      height: element.scrollHeight,
      scrollX: 0,
      scrollY: 0
    });

    // PDF ìƒì„±
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    
    // ìº”ë²„ìŠ¤ í¬ê¸° ê³„ì‚°
    const canvasWidth = canvas.width;
    const canvasHeight = canvas.height;
    
    // PDF í˜ì´ì§€ì— ë§ê²Œ í¬ê¸° ì¡°ì •
    const ratio = Math.min(pageWidth / (canvasWidth * 0.264583), pageHeight / (canvasHeight * 0.264583));
    const imgWidth = canvasWidth * 0.264583 * ratio;
    const imgHeight = canvasHeight * 0.264583 * ratio;
    
    // ì¤‘ì•™ ì •ë ¬
    const x = (pageWidth - imgWidth) / 2;
    const y = 10; // ìƒë‹¨ ì—¬ë°±

    // ì´ë¯¸ì§€ë¥¼ PDFì— ì¶”ê°€
    const imgData = canvas.toDataURL('image/png');
    
    // í˜ì´ì§€ê°€ ê¸¸ë©´ ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë¶„í• 
    if (imgHeight > pageHeight - 20) {
      // í˜ì´ì§€ë¥¼ ë‚˜ëˆ„ì–´ì„œ ì²˜ë¦¬
      const pageRatio = (pageHeight - 20) / imgHeight;
      const adjustedHeight = pageHeight - 20;
      const adjustedWidth = imgWidth * pageRatio;
      
      pdf.addImage(imgData, 'PNG', x, y, adjustedWidth, adjustedHeight);
      
      // ì¶”ê°€ í˜ì´ì§€ê°€ í•„ìš”í•œ ê²½ìš° (í˜„ì¬ëŠ” 1í˜ì´ì§€ë§Œ)
    } else {
      pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
    }

    // íŒŒì¼ëª… ìƒì„±
    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
    const fileName = `InnerMap_AI_ë¶„ì„ê²°ê³¼_${timestamp}.pdf`;
    
    // PDF ë‹¤ìš´ë¡œë“œ
    pdf.save(fileName);
    
    return {
      success: true,
      fileName: fileName
    };
    
  } catch (error) {
    console.error('PDF ìƒì„± ì—ëŸ¬:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

// ë¸Œë¼ìš°ì € í”„ë¦°íŠ¸ ê¸°ëŠ¥ í™œìš© (ë” ê°„ë‹¨í•œ ë°©ë²•)
export function generatePrintPDF() {
  try {
    // ë¸Œë¼ìš°ì € í”„ë¦°íŠ¸ ëŒ€í™”ìƒì ì—´ê¸°
    window.print();
    return { success: true };
  } catch (error) {
    console.error('í”„ë¦°íŠ¸ ì—ëŸ¬:', error);
    return { success: false, error: error.message };
  }
}

// í•œê¸€ í…ìŠ¤íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (fallback)
export function generateTextFile(analysisData, testResults) {
  try {
    const content = `
ğŸ§  InnerMap AI ì„±ê²© ë¶„ì„ ê²°ê³¼

ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
MBTI: ${testResults?.mbti || 'N/A'}
ì—ë‹ˆì–´ê·¸ë¨: ìœ í˜• ${testResults?.enneagram || 'N/A'}
ì„ íƒ ì»¬ëŸ¬: ${testResults?.colors?.map(c => c.name).join(', ') || 'ì„ íƒëœ ì»¬ëŸ¬ ì—†ìŒ'}

ğŸ¯ ì„±ê²© ìš”ì•½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${analysisData?.combined?.summary || 'ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'}

âœ¨ ë‹¹ì‹ ì˜ ê°•ì 
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${(analysisData?.combined?.strengths || []).map((s, i) => `${i + 1}. ${s}`).join('\n')}

ğŸš€ ì„±ì¥ í¬ì¸íŠ¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${(analysisData?.combined?.growth_areas || []).map((s, i) => `${i + 1}. ${s}`).join('\n')}

ğŸ’¡ ì¼ìƒ ì‹¤ì²œë²•
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${(analysisData?.combined?.daily_practices || []).map((s, i) => `${i + 1}. ${s}`).join('\n')}

ğŸ¯ ë§ˆì§€ë§‰ í•œ ë§ˆë””
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"${analysisData?.combined?.final_advice || 'ë‹¹ì‹ ë§Œì˜ ë…íŠ¹í•¨ì„ ë°œíœ˜í•˜ì„¸ìš”!'}"

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Generated by InnerMap AI
ë¶„ì„ ì™„ë£Œ: ${new Date().toLocaleString('ko-KR')}
    `;
    
    // UTF-8 BOM ì¶”ê°€í•˜ì—¬ í•œê¸€ ê¹¨ì§ ë°©ì§€
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `InnerMap_AI_ë¶„ì„ê²°ê³¼_${new Date().toISOString().slice(0, 10)}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    return { 
      success: true, 
      fileName: link.download,
      type: 'text'
    };
  } catch (error) {
    console.error('í…ìŠ¤íŠ¸ íŒŒì¼ ìƒì„± ì—ëŸ¬:', error);
    return { success: false, error: error.message };
  }
}

// PDF ì§€ì› ì—¬ë¶€ í™•ì¸
export function isPDFSupported() {
  return typeof window !== 'undefined' && 
         typeof document !== 'undefined';
}